# giipAgentWin μ‚¬μ–‘μ„ (Windows Agent)

> **π“… λ¬Έμ„ λ©”νƒ€λ°μ΄ν„°**
> - **μ‘μ„±μΌ**: 2025-12-07
> - **μ‘μ„±μ**: AI Agent
> - **λ©μ **: ν„λ€ν™”λ Windows Agent (`giipAgentWin`)μ μ•„ν‚¤ν…μ², API μ‚¬μ©λ²•, μ΄μ λ΅μ§ μ •μ
> - **μƒνƒ**: μ΄μ• (κµ¬ν„ μμ •)

---

## 1. κ°μ”

**μ»΄ν¬λ„νΈ**: `giipAgentWin`
**λ©”μΈ μ¤ν¬λ¦½νΈ**: `giipAgentWin.ps1`
**λ²„μ „**: 2.0 (Target)
**ν”λ«νΌ**: Windows PowerShell 5.1+ / PowerShell Core (pwsh) 7+
**μ•„ν‚¤ν…μ²**: ν•¨μ λΈ”λ΅μ„ ν¬ν•¨ν• λ¨λ†€λ¦¬μ‹ μ¤ν¬λ¦½νΈ (λλ” ν‘μ¤€ν™”λ λ¨λ“ν•)
**μ£Όμ” κΈ°λ¥**: μ¤‘μ•™ ν μ—”μ§„(CQE) ν΄λ§, ν μ‘μ—… μ‹¤ν–‰, κ²°κ³Ό λ³΄κ³ 

---

## 2. νμΌ κµ¬μ΅°

```
c:\installation_path\
β”β”€β”€ giipAgent.cfg               # μ„¤μ • νμΌ (λ¶€λ¨ λ””λ ‰ν† λ¦¬)
β””β”€β”€ giipAgentWin\
    β”β”€β”€ README.md               # λ¬Έμ„
    β”β”€β”€ giipAgentWin.ps1        # λ©”μΈ μ—μ΄μ „νΈ μ¤ν¬λ¦½νΈ
    β”β”€β”€ giip-auto-discover.ps1  # μλ™ κ²€μƒ‰(Auto Discovery) μ¤ν¬λ¦½νΈ
    β””β”€β”€ docs\                   # λ¬Έμ„ ν΄λ”
```

---

## 3. μ„¤μ • (`giipAgent.cfg`)

μ—μ΄μ „νΈλ” λ‹¤μ μμ„λ΅ μ„¤μ • νμΌμ„ μ°Ύμ•„μ•Ό ν•©λ‹λ‹¤:
1.  **λ¶€λ¨ λ””λ ‰ν† λ¦¬**: `../giipAgent.cfg` (μ¤ν¬λ¦½νΈ μ„μΉ κΈ°μ¤€ μƒλ€ κ²½λ΅)
2.  **μ‚¬μ©μ ν”„λ΅ν•„**: `$env:USERPROFILE\giipAgent.cfg`

**ν•μ‹**: INI μ¤νƒ€μΌ `key = value` μ
```ini
apiaddrv2 = "https://giipfaw.azurewebsites.net/api/giipApiSk2"
sk = "YOUR_SECURE_TOKEN"     # APIμ—μ„ 'token' νλΌλ―Έν„°λ΅ μ „μ†΅λ¨
lssn = "12345"               # λ…Όλ¦¬ μ„λ²„ μΌλ ¨λ²νΈ (Logical Server Serial Number)
giipagentdelay = "60"        # ν΄λ§ κ°„κ²© (μ΄)
debug = "0"
```

---

## 4. API ν†µμ‹  (μ¤‘μ”: V2 ν‘μ¤€ μ¤€μ)

μ—μ΄μ „νΈλ” λ°λ“μ‹ **V2 API μ—”λ“ν¬μΈνΈ** (`giipApiSk2`)λ§μ„ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

### 4.1. μ—”λ“ν¬μΈνΈ
- **URL**: μ„¤μ • νμΌμ `apiaddrv2` κ°’μ„ μ‚¬μ©
- **Method**: POST

### 4.2. μΈμ¦ (Authentication)
- **νλΌλ―Έν„°**: `token`
- **κ°’**: μ„¤μ • νμΌμ `sk` κ°’μ„ μ‚¬μ©
- **μ μ•½μ‚¬ν•­**: API μ”μ²­ λ³Έλ¬Έμ—μ„ μ λ€ `sk`λ¥Ό νλΌλ―Έν„° μ΄λ¦„μΌλ΅ μ‚¬μ©ν•μ§€ λ§μ‹­μ‹μ¤. λ°λ“μ‹ `token`μ„ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

### 4.3. μ”μ²­ ν•μ‹ (Multipart/Form-Data λλ” URL Encoded)

λ¨λ“  μ”μ²­μ€ `text` (λ…λ Ήμ–΄) + `jsondata` (νμ΄λ΅λ“) ν¨ν„΄μ„ λ”°λΌμ•Ό ν•©λ‹λ‹¤.

| νλΌλ―Έν„° | μ„¤λ… |
|-----------|-------------|
| `token` | μΈμ¦ ν† ν° (μ„¤μ •μ `sk` κ°’) |
| `text` | API λ…λ Ήμ–΄ + νλΌλ―Έν„° ν‚¤ (κ³µλ°±μΌλ΅ κµ¬λ¶„) |
| `jsondata` | μ‹¤μ  κ°’μ„ ν¬ν•¨ν•λ” JSON λ¬Έμμ—΄ |

**μμ‹: ν ν΄λ§ (`CQEQueueGet`)**
- `text`: `"CQEQueueGet kType kKey kFactor kValue"` (μμ‹, SPμ— λ”°λΌ λ‹¤λ¦„)
- μ‹¤μ  ν μ΅°νμ©: `pApiCQEQueueGetbySk` (via `giipApiSk2`)
    - `text`: `"CQEQueueGet lssn hn os sv df"`
    - `jsondata`: `{"lssn":"12345", "hn":"WinSvr01", "os":"Windows Server 2019", "sv":"2.0", "df":"os"}`

**μμ‹: κ²°κ³Ό λ³΄κ³  (`KVSPut`)**
- `text`: `"KVSPut kType kKey kFactor kValue"`
- `jsondata`: 
  ```json
  {
    "kType": "lssn",
    "kKey": "12345",
    "kFactor": "giipAgentLog",
    "kValue": {
       "qsn": "999",
       "status": "success",
       "output": "..."
    }
  }
  ```

---

## 5. μ‹¤ν–‰ λ΅μ§

### 5.1. μ΄κΈ°ν™” (Initialization)
1.  **μ„¤μ • λ΅λ“**: `giipAgent.cfg`λ¥Ό μ°Ύμ•„ μ½μµλ‹λ‹¤.
2.  **κ²€μ¦**: `lssn`κ³Ό `sk` (token) κ°’μ΄ μ΅΄μ¬ν•λ”μ§€ ν™•μΈν•©λ‹λ‹¤.
3.  **ν™κ²½ κ°μ§€**: νΈμ¤νΈλ…, OS λ²„μ „μ„ μμ§‘ν•©λ‹λ‹¤.

### 5.2. λ©”μΈ λ£¨ν”„ (Main Loop)
1.  **ν ν΄λ§**: V2 APIλ¥Ό ν†µν•΄ `CQEQueueGet` νΈμ¶.
2.  **μ‘λ‹µ μ²λ¦¬**:
    - **λΉ κ°’/μ—λ¬**: λ΅κ·Έ κΈ°λ΅ ν›„ λ€κΈ°(Sleep).
    - **μ«μ (Numeric)**: `giipAgent.cfg`μ `lssn` μ—…λ°μ΄νΈ (μλ™ λ“±λ΅).
    - **λ¬Έμμ—΄ (Task)**: `QSN||TYPE||BODY` ν•μ‹ νμ‹±.
3.  **μ‘μ—… μ‹¤ν–‰**:
    - **μ ν•**: `ps1`, `cmd`, `wsf`.
    - **λ™μ‘**: λ‚΄μ©μ„ μ„μ‹ νμΌλ΅ μ‘μ„± -> μ‹¤ν–‰ -> ν‘μ¤€ μ¶λ ¥/μ—λ¬ μΊ΅μ².
4.  **κ²°κ³Ό λ³΄κ³ **: V2 APIλ¥Ό ν†µν•΄ `KVSPut` νΈμ¶ (κ²°κ³Ό μ¤λ‹ν« μµλ€ 500μ).

### 5.3. μ—λ¬ μ²λ¦¬
- **λ„¤νΈμ›ν¬ μ—λ¬**: λ°±μ¤ν”„(backoff)λ΅ μ¬μ‹λ„ν•κ±°λ‚ λ΅κ·Έ κΈ°λ΅ ν›„ λ‹¤μ μ£ΌκΈ° λ€κΈ°.
- **μ‹¤ν–‰ μ—λ¬**: μΆ…λ£ μ½”λ“(Exit Code)μ™€ μ—λ¬ μ¶λ ¥(stderr)μ„ μΊ΅μ²ν•μ—¬ KVSμ— μ‹¤ν¨λ΅ λ³΄κ³ .
- **λ΅κΉ…**: λ΅μ»¬ λ΅κ·Έλ¥Ό `../giipLogs/giipAgentWin_YYYYMMDD.log`μ— κΈ°λ΅.

---

## 6. μ μ•½μ‚¬ν•­ λ° κ·μΉ™

1.  **`sk` νλΌλ―Έν„° κΈμ§€**: API μ”μ²­ μΏΌλ¦¬ μ¤νΈλ§μ΄λ‚ λ°”λ””μ— `sk=...`λ¥Ό μ λ€ ν¬ν•¨ν•μ§€ λ§μ‹­μ‹μ¤. ν•­μƒ `token=...`μ„ μ‚¬μ©ν•μ„Έμ”.
2.  **JSON ν•μ‹**: JSON νμ΄λ΅λ“μ— `timestamp`λ¥Ό ν¬ν•¨ν•μ§€ λ§μ‹­μ‹μ¤. μ„λ²„ μΈ΅μ `GETUTCDATE()`λ¥Ό μ‹ λΆ°ν•©λ‹λ‹¤.
3.  **μΈμ½”λ”©**: `jsondata`κ°€ μ¬λ°”λ¥΄κ² JSON μΈμ½”λ”©λμ—λ”μ§€ ν™•μΈν•μ‹­μ‹μ¤ (λ”°μ΄ν‘ μ΄μ¤μΌ€μ΄ν”„ λ“±).
4.  **μλ™ μ—…λ°μ΄νΈ**: `lssn`μ΄ λ³€κ²½λλ©΄ (μ«μ μ‘λ‹µ μμ‹  μ‹), λ¬Όλ¦¬μ μΈ μ„¤μ • νμΌμ„ μ¦‰μ‹ μ—…λ°μ΄νΈν•΄μ•Ό ν•©λ‹λ‹¤.
